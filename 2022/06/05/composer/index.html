<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
    
	<title>composer加载机制 - 不知有晋</title>
    <meta name="author" content="CFONG">
    
	<meta name="description" content="&lt;h1&gt;&lt;span id=&#34;ru-kou-wen-jian-index-php&#34;&gt;入口文件 index.php&lt;/span&gt;&lt;a href=&#34;#ru-kou-wen-jian-index-php&#34; class=&#34;header-anchor&#34;&gt;#&lt;/a&gt;&lt;/h1&gt;&lt;p&gt;引入 vendor 的 autoload.php 文件 &lt;/p&gt;
&lt;figure class=&#34;highlight php&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;require&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;__DIR__&lt;/span&gt; . &lt;span class=&#34;string&#34;&gt;&amp;#x27;/../vendor/autoload.php&amp;#x27;&lt;/span&gt;; &lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;


&lt;h1&gt;&lt;span id=&#34;vendor-x2f-autoload-php-wen-jian&#34;&gt;vendor&amp;#x2F;autoload.php 文件&lt;/span&gt;&lt;a href=&#34;#vendor-x2f-autoload-php-wen-jian&#34; class=&#34;header-anchor&#34;&gt;#&lt;/a&gt;&lt;/h1&gt;&lt;p&gt;引入 composer 的 autoload_real.php 文件，然后调用 getLoader 方法&lt;/p&gt;
&lt;figure class=&#34;highlight php&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;// autoload.php @generated by Composer&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;require_once&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;__DIR__&lt;/span&gt; . &lt;span class=&#34;string&#34;&gt;&amp;#x27;/composer/autoload_real.php&amp;#x27;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;ComposerAutoloaderInit558596bf02a1b04254bb0a6c8d3be828&lt;/span&gt;::&lt;span class=&#34;title function_ invoke__&#34;&gt;getLoader&lt;/span&gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h1&gt;&lt;span id=&#34;vendor-x2f-composer-x2f-autoload-real-php-wen-jian&#34;&gt;vendor&amp;#x2F;composer&amp;#x2F;autoload_real.php 文件&lt;/span&gt;&lt;a href=&#34;#vendor-x2f-composer-x2f-autoload-real-php-wen-jian&#34; class=&#34;header-anchor&#34;&gt;#&lt;/a&gt;&lt;/h1&gt;&lt;p&gt;该文件包含&lt;br&gt;&lt;strong&gt;ComposerAutoloaderInit558596bf02a1b04254bb0a6c8d3be828&lt;/strong&gt; 类&lt;br&gt;和引入文件函数 &lt;strong&gt;composerRequire558596bf02a1b04254bb0a6c8d3be828()&lt;/strong&gt; 。&lt;/p&gt;
&lt;h2&gt;&lt;span id=&#34;getloader-fang-fa&#34;&gt;getLoader方法&lt;/span&gt;&lt;a href=&#34;#getloader-fang-fa&#34; class=&#34;header-anchor&#34;&gt;#&lt;/a&gt;&lt;/h2&gt;&lt;h3&gt;&lt;span id=&#34;ban-ben-jian-ce&#34;&gt;版本检测&lt;/span&gt;&lt;a href=&#34;#ban-ben-jian-ce&#34; class=&#34;header-anchor&#34;&gt;#&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;首先引入文件：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;require __DIR__ . &amp;#x27;/platform_check.php&amp;#x27;;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;检查 composer 依赖需要的 php 版本与环境的 php 版本是否一致，如果环境的 php 版本低于要求的版本，则会返回错误信息。&lt;/p&gt;
&lt;h3&gt;&lt;span id=&#34;shi-li-hua-classloader-lei&#34;&gt;实例化 ClassLoader 类&lt;/span&gt;&lt;a href=&#34;#shi-li-hua-classloader-lei&#34; class=&#34;header-anchor&#34;&gt;#&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;使用 spl_autoload_register 注册 loadClassLoader 方法：&lt;/p&gt;
&lt;figure class=&#34;highlight php&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;static&lt;/span&gt; &lt;span class=&#34;function&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;function&lt;/span&gt; &lt;span class=&#34;title&#34;&gt;loadClassLoader&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$class&lt;/span&gt;&lt;/span&gt;)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;function&#34;&gt;&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (&lt;span class=&#34;string&#34;&gt;&amp;#x27;Composer\Autoload\ClassLoader&amp;#x27;&lt;/span&gt; === &lt;span class=&#34;variable&#34;&gt;$class&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;require&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;__DIR__&lt;/span&gt; . &lt;span class=&#34;string&#34;&gt;&amp;#x27;/ClassLoader.php&amp;#x27;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;loadClassLoader 方法接收一个类名参数，当类名是 Composer\Autoload\ClassLoader 的时候，引入同级目录下的 ClassLoader.php 文件。&lt;/p&gt;
&lt;p&gt;实例化 \Composer\Autoload\ClassLoader 类，参数是 vendor 目录的绝对路径，返回一个加载器实例 $loader。&lt;/p&gt;
&lt;figure class=&#34;highlight php&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;built_in&#34;&gt;self&lt;/span&gt;::&lt;span class=&#34;variable&#34;&gt;$loader&lt;/span&gt; = &lt;span class=&#34;variable&#34;&gt;$loader&lt;/span&gt; = &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;title class_&#34;&gt;\Composer\Autoload\ClassLoader&lt;/span&gt;(\&lt;span class=&#34;title function_ invoke__&#34;&gt;dirname&lt;/span&gt;(\&lt;span class=&#34;title function_ invoke__&#34;&gt;dirname&lt;/span&gt;(&lt;span class=&#34;keyword&#34;&gt;__FILE__&lt;/span&gt;)));&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;使用 spl_autoload_unregister 取消注册 loadClassLoader 方法。&lt;/p&gt;
&lt;h3&gt;&lt;span id=&#34;chu-shi-hua-loader-shi-li-de-shu-xing&#34;&gt;初始化 $loader 实例的属性&lt;/span&gt;&lt;a href=&#34;#chu-shi-hua-loader-shi-li-de-shu-xing&#34; class=&#34;header-anchor&#34;&gt;#&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;初始化 $loader 实例的属性有： prefixLengthsPsr4,prefixDirsPsr4,fallbackDirsPsr0,classMap 。&lt;/p&gt;
&lt;p&gt;根据环境变量的值（如php版本，是否定义HHVM_VERSION常量等）判断是否使用静态加载方式。&lt;/p&gt;
&lt;p&gt;若使用静态加载方式，则引入同级目录下的 autoload_static.php 文件，并且使用 call_user_func 方法回调 getInitializer 方法，参数是加载器实例$loader。&lt;/p&gt;
&lt;p&gt;autoload_static.php 文件定义了以上几个属性，通过 getInitializer 方法实现 $loader 属性初始化；&lt;/p&gt;
&lt;p&gt;若不使用静态加载方式，则分别引入同级目录下的 autoload_namespaces.php,autoload_psr4.php,autoload_classmap.php 文件，再调用 $loader 实例的 set(),setPsr4(),addClassMap() 方法实现 $loader 属性初始化；&lt;/p&gt;
&lt;h3&gt;&lt;span id=&#34;zhu-ce-zi-dong-jia-zai-han-shu&#34;&gt;注册自动加载函数&lt;/span&gt;&lt;a href=&#34;#zhu-ce-zi-dong-jia-zai-han-shu&#34; class=&#34;header-anchor&#34;&gt;#&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;使用 $loader 实例调用 register 方法，注册加载函数，register 方法体下面再说。&lt;/p&gt;
&lt;h3&gt;&lt;span id=&#34;yin-ru-dan-wen-jian&#34;&gt;引入单文件&lt;/span&gt;&lt;a href=&#34;#yin-ru-dan-wen-jian&#34; class=&#34;header-anchor&#34;&gt;#&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;通过读取配置文件，获取单文件映射数组，通过 composerRequire558596bf02a1b04254bb0a6c8d3be828 函数引入单文件。&lt;/p&gt;
&lt;h3&gt;&lt;span id=&#34;fan-hui-jia-zai-qi-loader&#34;&gt;返回加载器 $loader&lt;/span&gt;&lt;a href=&#34;#fan-hui-jia-zai-qi-loader&#34; class=&#34;header-anchor&#34;&gt;#&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;最后返回加载器 $loader 。&lt;/p&gt;
&lt;h1&gt;&lt;span id=&#34;vendor-x2f-composer-x2f-classloader-php-wen-jian&#34;&gt;vendor&amp;#x2F;composer&amp;#x2F;ClassLoader.php 文件&lt;/span&gt;&lt;a href=&#34;#vendor-x2f-composer-x2f-classloader-php-wen-jian&#34; class=&#34;header-anchor&#34;&gt;#&lt;/a&gt;&lt;/h1&gt;&lt;h2&gt;&lt;span id=&#34;register-fang-fa&#34;&gt;register 方法&lt;/span&gt;&lt;a href=&#34;#register-fang-fa&#34; class=&#34;header-anchor&#34;&gt;#&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;使用 spl_autoload_register 注册加载器方法 loadClass ，并且添加到函数队列之首。&lt;/p&gt;
&lt;h2&gt;&lt;span id=&#34;loadclass-fang-fa&#34;&gt;loadClass 方法&lt;/span&gt;&lt;a href=&#34;#loadclass-fang-fa&#34; class=&#34;header-anchor&#34;&gt;#&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;调用 findFile 方法，通过类名查找类，返回类的绝对路径，然后调用 includeFile 方法，引入文件。&lt;/p&gt;
&lt;h2&gt;&lt;span id=&#34;findfile-fang-fa&#34;&gt;findFile 方法&lt;/span&gt;&lt;a href=&#34;#findfile-fang-fa&#34; class=&#34;header-anchor&#34;&gt;#&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;findFile 方法使用 $loader 加载器在前面初始化的属性，根据类名查找类的绝对路径，后返回。&lt;/p&gt;
&lt;h3&gt;&lt;span id=&#34;shu-xing-zhi&#34;&gt;属性值&lt;/span&gt;&lt;a href=&#34;#shu-xing-zhi&#34; class=&#34;header-anchor&#34;&gt;#&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;ClassLoader 类有几个重要的属性。&lt;/p&gt;
&lt;p&gt;classMap 属性保存类名与文件绝对路径的映射&lt;/p&gt;
&lt;figure class=&#34;highlight php&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;static&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$classMap&lt;/span&gt; = &lt;span class=&#34;keyword&#34;&gt;array&lt;/span&gt; (&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;string&#34;&gt;&amp;#x27;Attribute&amp;#x27;&lt;/span&gt; =&amp;gt; &lt;span class=&#34;keyword&#34;&gt;__DIR__&lt;/span&gt; . &lt;span class=&#34;string&#34;&gt;&amp;#x27;/..&amp;#x27;&lt;/span&gt; . &lt;span class=&#34;string&#34;&gt;&amp;#x27;/symfony/polyfill-php80/Resources/stubs/Attribute.php&amp;#x27;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;string&#34;&gt;&amp;#x27;Composer\\InstalledVersions&amp;#x27;&lt;/span&gt; =&amp;gt; &lt;span class=&#34;keyword&#34;&gt;__DIR__&lt;/span&gt; . &lt;span class=&#34;string&#34;&gt;&amp;#x27;/..&amp;#x27;&lt;/span&gt; . &lt;span class=&#34;string&#34;&gt;&amp;#x27;/composer/InstalledVersions.php&amp;#x27;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;string&#34;&gt;&amp;#x27;PhpToken&amp;#x27;&lt;/span&gt; =&amp;gt; &lt;span class=&#34;keyword&#34;&gt;__DIR__&lt;/span&gt; . &lt;span class=&#34;string&#34;&gt;&amp;#x27;/..&amp;#x27;&lt;/span&gt; . &lt;span class=&#34;string&#34;&gt;&amp;#x27;/symfony/polyfill-php80/Resources/stubs/PhpToken.php&amp;#x27;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;string&#34;&gt;&amp;#x27;Stringable&amp;#x27;&lt;/span&gt; =&amp;gt; &lt;span class=&#34;keyword&#34;&gt;__DIR__&lt;/span&gt; . &lt;span class=&#34;string&#34;&gt;&amp;#x27;/..&amp;#x27;&lt;/span&gt; . &lt;span class=&#34;string&#34;&gt;&amp;#x27;/symfony/polyfill-php80/Resources/stubs/Stringable.php&amp;#x27;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;string&#34;&gt;&amp;#x27;UnhandledMatchError&amp;#x27;&lt;/span&gt; =&amp;gt; &lt;span class=&#34;keyword&#34;&gt;__DIR__&lt;/span&gt; . &lt;span class=&#34;string&#34;&gt;&amp;#x27;/..&amp;#x27;&lt;/span&gt; . &lt;span class=&#34;string&#34;&gt;&amp;#x27;/symfony/polyfill-php80/Resources/stubs/UnhandledMatchError.php&amp;#x27;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;string&#34;&gt;&amp;#x27;ValueError&amp;#x27;&lt;/span&gt; =&amp;gt; &lt;span class=&#34;keyword&#34;&gt;__DIR__&lt;/span&gt; . &lt;span class=&#34;string&#34;&gt;&amp;#x27;/..&amp;#x27;&lt;/span&gt; . &lt;span class=&#34;string&#34;&gt;&amp;#x27;/symfony/polyfill-php80/Resources/stubs/ValueError.php&amp;#x27;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;prefixLengthsPsr4 和 prefixDirsPsr4 属性保存命名空间与文件相对路径的映射&lt;/p&gt;
&lt;figure class=&#34;highlight php&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;37&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;// 保存命名空间与文件相对路径的映射，&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;static&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$prefixDirsPsr4&lt;/span&gt; = &lt;span class=&#34;keyword&#34;&gt;array&lt;/span&gt; (&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;string&#34;&gt;&amp;#x27;think\\view\\driver\\&amp;#x27;&lt;/span&gt; =&amp;gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;array&lt;/span&gt; (&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;number&#34;&gt;0&lt;/span&gt; =&amp;gt; &lt;span class=&#34;keyword&#34;&gt;__DIR__&lt;/span&gt; . &lt;span class=&#34;string&#34;&gt;&amp;#x27;/..&amp;#x27;&lt;/span&gt; . &lt;span class=&#34;string&#34;&gt;&amp;#x27;/topthink/think-view/src&amp;#x27;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    ),&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;string&#34;&gt;&amp;#x27;think\\trace\\&amp;#x27;&lt;/span&gt; =&amp;gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;array&lt;/span&gt; (&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;number&#34;&gt;0&lt;/span&gt; =&amp;gt; &lt;span class=&#34;keyword&#34;&gt;__DIR__&lt;/span&gt; . &lt;span class=&#34;string&#34;&gt;&amp;#x27;/..&amp;#x27;&lt;/span&gt; . &lt;span class=&#34;string&#34;&gt;&amp;#x27;/topthink/think-trace/src&amp;#x27;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    ),&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;string&#34;&gt;&amp;#x27;think\\&amp;#x27;&lt;/span&gt; =&amp;gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;array&lt;/span&gt; (&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;number&#34;&gt;0&lt;/span&gt; =&amp;gt; &lt;span class=&#34;keyword&#34;&gt;__DIR__&lt;/span&gt; . &lt;span class=&#34;string&#34;&gt;&amp;#x27;/..&amp;#x27;&lt;/span&gt; . &lt;span class=&#34;string&#34;&gt;&amp;#x27;/topthink/framework/src/think&amp;#x27;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;number&#34;&gt;1&lt;/span&gt; =&amp;gt; &lt;span class=&#34;keyword&#34;&gt;__DIR__&lt;/span&gt; . &lt;span class=&#34;string&#34;&gt;&amp;#x27;/..&amp;#x27;&lt;/span&gt; . &lt;span class=&#34;string&#34;&gt;&amp;#x27;/topthink/think-helper/src&amp;#x27;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;number&#34;&gt;2&lt;/span&gt; =&amp;gt; &lt;span class=&#34;keyword&#34;&gt;__DIR__&lt;/span&gt; . &lt;span class=&#34;string&#34;&gt;&amp;#x27;/..&amp;#x27;&lt;/span&gt; . &lt;span class=&#34;string&#34;&gt;&amp;#x27;/topthink/think-orm/src&amp;#x27;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;number&#34;&gt;3&lt;/span&gt; =&amp;gt; &lt;span class=&#34;keyword&#34;&gt;__DIR__&lt;/span&gt; . &lt;span class=&#34;string&#34;&gt;&amp;#x27;/..&amp;#x27;&lt;/span&gt; . &lt;span class=&#34;string&#34;&gt;&amp;#x27;/topthink/think-template/src&amp;#x27;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    ),&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;string&#34;&gt;&amp;#x27;app\\&amp;#x27;&lt;/span&gt; =&amp;gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;array&lt;/span&gt; (&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;number&#34;&gt;0&lt;/span&gt; =&amp;gt; &lt;span class=&#34;keyword&#34;&gt;__DIR__&lt;/span&gt; . &lt;span class=&#34;string&#34;&gt;&amp;#x27;/../..&amp;#x27;&lt;/span&gt; . &lt;span class=&#34;string&#34;&gt;&amp;#x27;/app&amp;#x27;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    ),&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;comment&#34;&gt;// 以下省略&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;// 保存命名空间首字母为键的二维数组&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;static&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$prefixLengthsPsr4&lt;/span&gt; = &lt;span class=&#34;keyword&#34;&gt;array&lt;/span&gt; (&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;string&#34;&gt;&amp;#x27;t&amp;#x27;&lt;/span&gt; =&amp;gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;array&lt;/span&gt; (&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;string&#34;&gt;&amp;#x27;think\\view\\driver\\&amp;#x27;&lt;/span&gt; =&amp;gt; &lt;span class=&#34;number&#34;&gt;18&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;string&#34;&gt;&amp;#x27;think\\trace\\&amp;#x27;&lt;/span&gt; =&amp;gt; &lt;span class=&#34;number&#34;&gt;12&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;string&#34;&gt;&amp;#x27;think\\&amp;#x27;&lt;/span&gt; =&amp;gt; &lt;span class=&#34;number&#34;&gt;6&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    ),&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;string&#34;&gt;&amp;#x27;a&amp;#x27;&lt;/span&gt; =&amp;gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;array&lt;/span&gt; (&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;string&#34;&gt;&amp;#x27;app\\&amp;#x27;&lt;/span&gt; =&amp;gt; &lt;span class=&#34;number&#34;&gt;4&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    ),&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;comment&#34;&gt;// 以下省略&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;fallbackDirsPsr0 属性保存 $rootPath&amp;#x2F;extend&amp;#x2F; 目录下的文件&lt;/p&gt;
&lt;figure class=&#34;highlight php&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;public&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;static&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$fallbackDirsPsr0&lt;/span&gt; = &lt;span class=&#34;keyword&#34;&gt;array&lt;/span&gt; (&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;number&#34;&gt;0&lt;/span&gt; =&amp;gt; &lt;span class=&#34;keyword&#34;&gt;__DIR__&lt;/span&gt; . &lt;span class=&#34;string&#34;&gt;&amp;#x27;/../..&amp;#x27;&lt;/span&gt; . &lt;span class=&#34;string&#34;&gt;&amp;#x27;/extend&amp;#x27;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h3&gt;&lt;span id=&#34;cha-zhao-classmap-lei-ying-she&#34;&gt;查找 classMap 类映射&lt;/span&gt;&lt;a href=&#34;#cha-zhao-classmap-lei-ying-she&#34; class=&#34;header-anchor&#34;&gt;#&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;首先查找类名与文件绝对路径的映射，找到则返回文件路径&lt;/p&gt;
&lt;figure class=&#34;highlight php&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;// class map lookup&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (&lt;span class=&#34;keyword&#34;&gt;isset&lt;/span&gt;(&lt;span class=&#34;variable language_&#34;&gt;$this&lt;/span&gt;-&amp;gt;classMap[&lt;span class=&#34;variable&#34;&gt;$class&lt;/span&gt;])) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;variable language_&#34;&gt;$this&lt;/span&gt;-&amp;gt;classMap[&lt;span class=&#34;variable&#34;&gt;$class&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;若以上没有匹配到目标类，则继续向下执行。&lt;/p&gt;
&lt;p&gt;调用 findFileWithExtension 方法，使用其余3个属性查找文件路径。&lt;/p&gt;
&lt;h2&gt;&lt;span id=&#34;findfilewithextension-fang-fa&#34;&gt;findFileWithExtension 方法&lt;/span&gt;&lt;a href=&#34;#findfilewithextension-fang-fa&#34; class=&#34;header-anchor&#34;&gt;#&lt;/a&gt;&lt;/h2&gt;&lt;h3&gt;&lt;span id=&#34;cha-zhao-pi-pei-de-ming-ming-kong-jian&#34;&gt;查找匹配的命名空间&lt;/span&gt;&lt;a href=&#34;#cha-zhao-pi-pei-de-ming-ming-kong-jian&#34; class=&#34;header-anchor&#34;&gt;#&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;findFileWithExtension 方法的第一个参数是一个类名，通过类名的首字母判断 prefixLengthsPsr4 属性是否存在对应的命名空间。&lt;br&gt;如果不存在的话，就进入下一个属性 fallbackDirsPsr0 的判断。&lt;/p&gt;
&lt;p&gt;如果存在的话，进入一个 while 循环，直到找到第一个存在的文件路径后返回。&lt;/p&gt;
&lt;figure class=&#34;highlight php&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;// PSR-4 lookup&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$logicalPathPsr4&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;strtr&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$class&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;#x27;\\&amp;#x27;&lt;/span&gt;, DIRECTORY_SEPARATOR) . &lt;span class=&#34;variable&#34;&gt;$ext&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$first&lt;/span&gt; = &lt;span class=&#34;variable&#34;&gt;$class&lt;/span&gt;[&lt;span class=&#34;number&#34;&gt;0&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (&lt;span class=&#34;keyword&#34;&gt;isset&lt;/span&gt;(&lt;span class=&#34;variable language_&#34;&gt;$this&lt;/span&gt;-&amp;gt;prefixLengthsPsr4[&lt;span class=&#34;variable&#34;&gt;$first&lt;/span&gt;])) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;variable&#34;&gt;$subPath&lt;/span&gt; = &lt;span class=&#34;variable&#34;&gt;$class&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;while&lt;/span&gt; (&lt;span class=&#34;literal&#34;&gt;false&lt;/span&gt; !== &lt;span class=&#34;variable&#34;&gt;$lastPos&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;strrpos&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$subPath&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;#x27;\\&amp;#x27;&lt;/span&gt;)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$subPath&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;substr&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$subPath&lt;/span&gt;, &lt;span class=&#34;number&#34;&gt;0&lt;/span&gt;, &lt;span class=&#34;variable&#34;&gt;$lastPos&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$search&lt;/span&gt; = &lt;span class=&#34;variable&#34;&gt;$subPath&lt;/span&gt; . &lt;span class=&#34;string&#34;&gt;&amp;#x27;\\&amp;#x27;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (&lt;span class=&#34;keyword&#34;&gt;isset&lt;/span&gt;(&lt;span class=&#34;variable language_&#34;&gt;$this&lt;/span&gt;-&amp;gt;prefixDirsPsr4[&lt;span class=&#34;variable&#34;&gt;$search&lt;/span&gt;])) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;variable&#34;&gt;$pathEnd&lt;/span&gt; = DIRECTORY_SEPARATOR . &lt;span class=&#34;title function_ invoke__&#34;&gt;substr&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$logicalPathPsr4&lt;/span&gt;, &lt;span class=&#34;variable&#34;&gt;$lastPos&lt;/span&gt; + &lt;span class=&#34;number&#34;&gt;1&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;foreach&lt;/span&gt; (&lt;span class=&#34;variable language_&#34;&gt;$this&lt;/span&gt;-&amp;gt;prefixDirsPsr4[&lt;span class=&#34;variable&#34;&gt;$search&lt;/span&gt;] &lt;span class=&#34;keyword&#34;&gt;as&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$dir&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (&lt;span class=&#34;title function_ invoke__&#34;&gt;file_exists&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$file&lt;/span&gt; = &lt;span class=&#34;variable&#34;&gt;$dir&lt;/span&gt; . &lt;span class=&#34;variable&#34;&gt;$pathEnd&lt;/span&gt;)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                    &lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$file&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;while 循环里，首先找到类名里最后一个反斜杠 “&amp;quot; 的位置 $lastPos ,&lt;br&gt;从第0位到 $lastPos 位截取类名，得到一个字符串 $subPath ，&lt;br&gt;字符串 $subPath 后拼接一个反斜杠 “&amp;quot;，得到一个[可能是的]命名空间 $search ，&lt;br&gt;prefixDirsPsr4 属性保存命名空间与相对路径的映射，判断 $search 是否存在 prefixDirsPsr4 映射中，&lt;br&gt;如果存在，则返回一个数组，包含有一个或者多个路径，&lt;br&gt;从第 $lastPos + 1 位到最后一位截取类名，保留除命中的命名空间外的类名 $pathEnd ， $pathEnd 与命名空间映射的相对路径拼接成绝对路径，判断文件路径是否存在，存在则返回文件路径。&lt;/p&gt;
&lt;h3&gt;&lt;span id=&#34;mu-biao-lei-zai-rootpath-x2f-extend-x2f-mu-lu&#34;&gt;目标类在 $rootPath&amp;#x2F;extend&amp;#x2F; 目录&lt;/span&gt;&lt;a href=&#34;#mu-biao-lei-zai-rootpath-x2f-extend-x2f-mu-lu&#34; class=&#34;header-anchor&#34;&gt;#&lt;/a&gt;&lt;/h3&gt;&lt;figure class=&#34;highlight php&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;// PSR-0 fallback dirs&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;foreach&lt;/span&gt; (&lt;span class=&#34;variable language_&#34;&gt;$this&lt;/span&gt;-&amp;gt;fallbackDirsPsr0 &lt;span class=&#34;keyword&#34;&gt;as&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$dir&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (&lt;span class=&#34;title function_ invoke__&#34;&gt;file_exists&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$file&lt;/span&gt; = &lt;span class=&#34;variable&#34;&gt;$dir&lt;/span&gt; . DIRECTORY_SEPARATOR . &lt;span class=&#34;variable&#34;&gt;$logicalPathPsr0&lt;/span&gt;)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;variable&#34;&gt;$file&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;遍历 fallbackDirsPsr0 属性，与类名拼接成一个路径，文件路径真实存在则返回。&lt;/p&gt;
"> <!-- TODO: truncate -->
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="atom.xml" rel="alternate" title="不知有晋" type="application/atom+xml">
	<link href="/favicon.ico" rel="shortcut icon">
    <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
    <link href="/stylesheets/custom.css" media="screen, projection" rel="stylesheet" type="text/css">
    <link href="/stylesheets/hljs.css" media="screen, projection" rel="stylesheet" type="text/css">

    <link href='//fonts.googleapis.com/css?family=Slackey' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Amethysta' rel='stylesheet' type='text/css'>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
    <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![}]-->

    <script type="text/javascript" src="/javascripts/jquery-tapir.js"></script>
    <script src="/javascripts/MathJax.js" type="text/javascript"></script>
    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
            tex2jax: {
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
            inlineMath: [['$','$']]
            }
        });
    </script>
    <!-- remove or comment it to disable ajaxification -->   
    <!-- <script src="/javascripts/ajaxify.js"></script> -->

    

    

<meta name="generator" content="Hexo 6.2.0"></head>


<body>
    <div id="wrapper">
    <header id="header" class="inner"><!-- for more effects see _animate.scss -->
<h1 class="animated bounceInDown">
    <div id="headerbg">
        不知有晋
    </div>
</h1>
<span class="subtitle"></span>
<br>

<ul id="social-links" style="text-align:center; clear:both;">
  
  
  
  
  
  
  
  
</ul>


<!-- use full url including 'index.html' for navigation bar if you are using ajax -->
<ul id="nav">
	<li id="ajax"><a href="/index.html">Home</a></li>
	<li id="ajax"><a href="/archives/index.html">Archives</a></li>
	<li id="ajax"><a href="/tags/index.html">Tags</a></li>
    <li><a href="/atom.xml">RSS</a></li>
    
    <li>
    <div id="dark">
        <form action="//www.google.com.hk/search" method="get" accept-charset="UTF-8" id="search">
            <input type="hidden" name="sitesearch" value="http://chenfeng.org" />
            <input type="text" name="q" results="0" placeholder="Search..." x-webkit-speech />
        </form>
    </div>
    </li>
        
</ul>




</header>

<div id="toload">
<!-- begin toload -->
    <div id="content" class="inner">
        <article class="post">
	<h2 class="title">composer加载机制</h2>
    <div class="meta">
        <div class="date">Published on: <time datetime="2022-06-05T06:00:00.000Z" itemprop="datePublished">Jun 5, 2022</time>
</div>
        <div class="tags">Tags: 

<a href="/tags/php/">php</a> <a href="/tags/composer/">composer</a>
</div>
    </div>
	<div class="entry-content"><h1><span id="ru-kou-wen-jian-index-php">入口文件 index.php</span><a href="#ru-kou-wen-jian-index-php" class="header-anchor">#</a></h1><p>引入 vendor 的 autoload.php 文件 </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">&#x27;/../vendor/autoload.php&#x27;</span>; </span><br></pre></td></tr></table></figure>


<h1><span id="vendor-x2f-autoload-php-wen-jian">vendor&#x2F;autoload.php 文件</span><a href="#vendor-x2f-autoload-php-wen-jian" class="header-anchor">#</a></h1><p>引入 composer 的 autoload_real.php 文件，然后调用 getLoader 方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// autoload.php @generated by Composer</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require_once</span> <span class="keyword">__DIR__</span> . <span class="string">&#x27;/composer/autoload_real.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="title class_">ComposerAutoloaderInit558596bf02a1b04254bb0a6c8d3be828</span>::<span class="title function_ invoke__">getLoader</span>();</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1><span id="vendor-x2f-composer-x2f-autoload-real-php-wen-jian">vendor&#x2F;composer&#x2F;autoload_real.php 文件</span><a href="#vendor-x2f-composer-x2f-autoload-real-php-wen-jian" class="header-anchor">#</a></h1><p>该文件包含<br><strong>ComposerAutoloaderInit558596bf02a1b04254bb0a6c8d3be828</strong> 类<br>和引入文件函数 <strong>composerRequire558596bf02a1b04254bb0a6c8d3be828()</strong> 。</p>
<h2><span id="getloader-fang-fa">getLoader方法</span><a href="#getloader-fang-fa" class="header-anchor">#</a></h2><h3><span id="ban-ben-jian-ce">版本检测</span><a href="#ban-ben-jian-ce" class="header-anchor">#</a></h3><p>首先引入文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">require __DIR__ . &#x27;/platform_check.php&#x27;;</span><br></pre></td></tr></table></figure>
<p>检查 composer 依赖需要的 php 版本与环境的 php 版本是否一致，如果环境的 php 版本低于要求的版本，则会返回错误信息。</p>
<h3><span id="shi-li-hua-classloader-lei">实例化 ClassLoader 类</span><a href="#shi-li-hua-classloader-lei" class="header-anchor">#</a></h3><p>使用 spl_autoload_register 注册 loadClassLoader 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">loadClassLoader</span>(<span class="params"><span class="variable">$class</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&#x27;Composer\Autoload\ClassLoader&#x27;</span> === <span class="variable">$class</span>) &#123;</span><br><span class="line">        <span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">&#x27;/ClassLoader.php&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>loadClassLoader 方法接收一个类名参数，当类名是 Composer\Autoload\ClassLoader 的时候，引入同级目录下的 ClassLoader.php 文件。</p>
<p>实例化 \Composer\Autoload\ClassLoader 类，参数是 vendor 目录的绝对路径，返回一个加载器实例 $loader。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">self</span>::<span class="variable">$loader</span> = <span class="variable">$loader</span> = <span class="keyword">new</span> <span class="title class_">\Composer\Autoload\ClassLoader</span>(\<span class="title function_ invoke__">dirname</span>(\<span class="title function_ invoke__">dirname</span>(<span class="keyword">__FILE__</span>)));</span><br></pre></td></tr></table></figure>

<p>使用 spl_autoload_unregister 取消注册 loadClassLoader 方法。</p>
<h3><span id="chu-shi-hua-loader-shi-li-de-shu-xing">初始化 $loader 实例的属性</span><a href="#chu-shi-hua-loader-shi-li-de-shu-xing" class="header-anchor">#</a></h3><p>初始化 $loader 实例的属性有： prefixLengthsPsr4,prefixDirsPsr4,fallbackDirsPsr0,classMap 。</p>
<p>根据环境变量的值（如php版本，是否定义HHVM_VERSION常量等）判断是否使用静态加载方式。</p>
<p>若使用静态加载方式，则引入同级目录下的 autoload_static.php 文件，并且使用 call_user_func 方法回调 getInitializer 方法，参数是加载器实例$loader。</p>
<p>autoload_static.php 文件定义了以上几个属性，通过 getInitializer 方法实现 $loader 属性初始化；</p>
<p>若不使用静态加载方式，则分别引入同级目录下的 autoload_namespaces.php,autoload_psr4.php,autoload_classmap.php 文件，再调用 $loader 实例的 set(),setPsr4(),addClassMap() 方法实现 $loader 属性初始化；</p>
<h3><span id="zhu-ce-zi-dong-jia-zai-han-shu">注册自动加载函数</span><a href="#zhu-ce-zi-dong-jia-zai-han-shu" class="header-anchor">#</a></h3><p>使用 $loader 实例调用 register 方法，注册加载函数，register 方法体下面再说。</p>
<h3><span id="yin-ru-dan-wen-jian">引入单文件</span><a href="#yin-ru-dan-wen-jian" class="header-anchor">#</a></h3><p>通过读取配置文件，获取单文件映射数组，通过 composerRequire558596bf02a1b04254bb0a6c8d3be828 函数引入单文件。</p>
<h3><span id="fan-hui-jia-zai-qi-loader">返回加载器 $loader</span><a href="#fan-hui-jia-zai-qi-loader" class="header-anchor">#</a></h3><p>最后返回加载器 $loader 。</p>
<h1><span id="vendor-x2f-composer-x2f-classloader-php-wen-jian">vendor&#x2F;composer&#x2F;ClassLoader.php 文件</span><a href="#vendor-x2f-composer-x2f-classloader-php-wen-jian" class="header-anchor">#</a></h1><h2><span id="register-fang-fa">register 方法</span><a href="#register-fang-fa" class="header-anchor">#</a></h2><p>使用 spl_autoload_register 注册加载器方法 loadClass ，并且添加到函数队列之首。</p>
<h2><span id="loadclass-fang-fa">loadClass 方法</span><a href="#loadclass-fang-fa" class="header-anchor">#</a></h2><p>调用 findFile 方法，通过类名查找类，返回类的绝对路径，然后调用 includeFile 方法，引入文件。</p>
<h2><span id="findfile-fang-fa">findFile 方法</span><a href="#findfile-fang-fa" class="header-anchor">#</a></h2><p>findFile 方法使用 $loader 加载器在前面初始化的属性，根据类名查找类的绝对路径，后返回。</p>
<h3><span id="shu-xing-zhi">属性值</span><a href="#shu-xing-zhi" class="header-anchor">#</a></h3><p>ClassLoader 类有几个重要的属性。</p>
<p>classMap 属性保存类名与文件绝对路径的映射</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="variable">$classMap</span> = <span class="keyword">array</span> (</span><br><span class="line">    <span class="string">&#x27;Attribute&#x27;</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">&#x27;/..&#x27;</span> . <span class="string">&#x27;/symfony/polyfill-php80/Resources/stubs/Attribute.php&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Composer\\InstalledVersions&#x27;</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">&#x27;/..&#x27;</span> . <span class="string">&#x27;/composer/InstalledVersions.php&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;PhpToken&#x27;</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">&#x27;/..&#x27;</span> . <span class="string">&#x27;/symfony/polyfill-php80/Resources/stubs/PhpToken.php&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Stringable&#x27;</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">&#x27;/..&#x27;</span> . <span class="string">&#x27;/symfony/polyfill-php80/Resources/stubs/Stringable.php&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;UnhandledMatchError&#x27;</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">&#x27;/..&#x27;</span> . <span class="string">&#x27;/symfony/polyfill-php80/Resources/stubs/UnhandledMatchError.php&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;ValueError&#x27;</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">&#x27;/..&#x27;</span> . <span class="string">&#x27;/symfony/polyfill-php80/Resources/stubs/ValueError.php&#x27;</span>,</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>prefixLengthsPsr4 和 prefixDirsPsr4 属性保存命名空间与文件相对路径的映射</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 保存命名空间与文件相对路径的映射，</span></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="variable">$prefixDirsPsr4</span> = <span class="keyword">array</span> (</span><br><span class="line">    <span class="string">&#x27;think\\view\\driver\\&#x27;</span> =&gt; </span><br><span class="line">    <span class="keyword">array</span> (</span><br><span class="line">        <span class="number">0</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">&#x27;/..&#x27;</span> . <span class="string">&#x27;/topthink/think-view/src&#x27;</span>,</span><br><span class="line">    ),</span><br><span class="line">    <span class="string">&#x27;think\\trace\\&#x27;</span> =&gt; </span><br><span class="line">    <span class="keyword">array</span> (</span><br><span class="line">        <span class="number">0</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">&#x27;/..&#x27;</span> . <span class="string">&#x27;/topthink/think-trace/src&#x27;</span>,</span><br><span class="line">    ),</span><br><span class="line">    <span class="string">&#x27;think\\&#x27;</span> =&gt; </span><br><span class="line">    <span class="keyword">array</span> (</span><br><span class="line">        <span class="number">0</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">&#x27;/..&#x27;</span> . <span class="string">&#x27;/topthink/framework/src/think&#x27;</span>,</span><br><span class="line">        <span class="number">1</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">&#x27;/..&#x27;</span> . <span class="string">&#x27;/topthink/think-helper/src&#x27;</span>,</span><br><span class="line">        <span class="number">2</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">&#x27;/..&#x27;</span> . <span class="string">&#x27;/topthink/think-orm/src&#x27;</span>,</span><br><span class="line">        <span class="number">3</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">&#x27;/..&#x27;</span> . <span class="string">&#x27;/topthink/think-template/src&#x27;</span>,</span><br><span class="line">    ),</span><br><span class="line">    <span class="string">&#x27;app\\&#x27;</span> =&gt; </span><br><span class="line">    <span class="keyword">array</span> (</span><br><span class="line">        <span class="number">0</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">&#x27;/../..&#x27;</span> . <span class="string">&#x27;/app&#x27;</span>,</span><br><span class="line">    ),</span><br><span class="line">    <span class="comment">// 以下省略</span></span><br><span class="line">);</span><br><span class="line"><span class="comment">// 保存命名空间首字母为键的二维数组</span></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="variable">$prefixLengthsPsr4</span> = <span class="keyword">array</span> (</span><br><span class="line">    <span class="string">&#x27;t&#x27;</span> =&gt; </span><br><span class="line">    <span class="keyword">array</span> (</span><br><span class="line">        <span class="string">&#x27;think\\view\\driver\\&#x27;</span> =&gt; <span class="number">18</span>,</span><br><span class="line">        <span class="string">&#x27;think\\trace\\&#x27;</span> =&gt; <span class="number">12</span>,</span><br><span class="line">        <span class="string">&#x27;think\\&#x27;</span> =&gt; <span class="number">6</span>,</span><br><span class="line">    ),</span><br><span class="line">    <span class="string">&#x27;a&#x27;</span> =&gt; </span><br><span class="line">    <span class="keyword">array</span> (</span><br><span class="line">        <span class="string">&#x27;app\\&#x27;</span> =&gt; <span class="number">4</span>,</span><br><span class="line">    ),</span><br><span class="line">    <span class="comment">// 以下省略</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>fallbackDirsPsr0 属性保存 $rootPath&#x2F;extend&#x2F; 目录下的文件</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="variable">$fallbackDirsPsr0</span> = <span class="keyword">array</span> (</span><br><span class="line">    <span class="number">0</span> =&gt; <span class="keyword">__DIR__</span> . <span class="string">&#x27;/../..&#x27;</span> . <span class="string">&#x27;/extend&#x27;</span>,</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h3><span id="cha-zhao-classmap-lei-ying-she">查找 classMap 类映射</span><a href="#cha-zhao-classmap-lei-ying-she" class="header-anchor">#</a></h3><p>首先查找类名与文件绝对路径的映射，找到则返回文件路径</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// class map lookup</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;classMap[<span class="variable">$class</span>])) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;classMap[<span class="variable">$class</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>若以上没有匹配到目标类，则继续向下执行。</p>
<p>调用 findFileWithExtension 方法，使用其余3个属性查找文件路径。</p>
<h2><span id="findfilewithextension-fang-fa">findFileWithExtension 方法</span><a href="#findfilewithextension-fang-fa" class="header-anchor">#</a></h2><h3><span id="cha-zhao-pi-pei-de-ming-ming-kong-jian">查找匹配的命名空间</span><a href="#cha-zhao-pi-pei-de-ming-ming-kong-jian" class="header-anchor">#</a></h3><p>findFileWithExtension 方法的第一个参数是一个类名，通过类名的首字母判断 prefixLengthsPsr4 属性是否存在对应的命名空间。<br>如果不存在的话，就进入下一个属性 fallbackDirsPsr0 的判断。</p>
<p>如果存在的话，进入一个 while 循环，直到找到第一个存在的文件路径后返回。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PSR-4 lookup</span></span><br><span class="line"><span class="variable">$logicalPathPsr4</span> = <span class="title function_ invoke__">strtr</span>(<span class="variable">$class</span>, <span class="string">&#x27;\\&#x27;</span>, DIRECTORY_SEPARATOR) . <span class="variable">$ext</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$first</span> = <span class="variable">$class</span>[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;prefixLengthsPsr4[<span class="variable">$first</span>])) &#123;</span><br><span class="line">    <span class="variable">$subPath</span> = <span class="variable">$class</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">false</span> !== <span class="variable">$lastPos</span> = <span class="title function_ invoke__">strrpos</span>(<span class="variable">$subPath</span>, <span class="string">&#x27;\\&#x27;</span>)) &#123;</span><br><span class="line">        <span class="variable">$subPath</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$subPath</span>, <span class="number">0</span>, <span class="variable">$lastPos</span>);</span><br><span class="line">        <span class="variable">$search</span> = <span class="variable">$subPath</span> . <span class="string">&#x27;\\&#x27;</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;prefixDirsPsr4[<span class="variable">$search</span>])) &#123;</span><br><span class="line">            <span class="variable">$pathEnd</span> = DIRECTORY_SEPARATOR . <span class="title function_ invoke__">substr</span>(<span class="variable">$logicalPathPsr4</span>, <span class="variable">$lastPos</span> + <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;prefixDirsPsr4[<span class="variable">$search</span>] <span class="keyword">as</span> <span class="variable">$dir</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(<span class="variable">$file</span> = <span class="variable">$dir</span> . <span class="variable">$pathEnd</span>)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="variable">$file</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>while 循环里，首先找到类名里最后一个反斜杠 “&quot; 的位置 $lastPos ,<br>从第0位到 $lastPos 位截取类名，得到一个字符串 $subPath ，<br>字符串 $subPath 后拼接一个反斜杠 “&quot;，得到一个[可能是的]命名空间 $search ，<br>prefixDirsPsr4 属性保存命名空间与相对路径的映射，判断 $search 是否存在 prefixDirsPsr4 映射中，<br>如果存在，则返回一个数组，包含有一个或者多个路径，<br>从第 $lastPos + 1 位到最后一位截取类名，保留除命中的命名空间外的类名 $pathEnd ， $pathEnd 与命名空间映射的相对路径拼接成绝对路径，判断文件路径是否存在，存在则返回文件路径。</p>
<h3><span id="mu-biao-lei-zai-rootpath-x2f-extend-x2f-mu-lu">目标类在 $rootPath&#x2F;extend&#x2F; 目录</span><a href="#mu-biao-lei-zai-rootpath-x2f-extend-x2f-mu-lu" class="header-anchor">#</a></h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PSR-0 fallback dirs</span></span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;fallbackDirsPsr0 <span class="keyword">as</span> <span class="variable">$dir</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(<span class="variable">$file</span> = <span class="variable">$dir</span> . DIRECTORY_SEPARATOR . <span class="variable">$logicalPathPsr0</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$file</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>遍历 fallbackDirsPsr0 属性，与类名拼接成一个路径，文件路径真实存在则返回。</p>
</div>

<div class="meta">
	
</div>
</article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
	
	
	<a class="addthis_button_tweet"></a>
	
	
	<a class="addthis_counter addthis_pill_style"></a>
	</div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>




    </div>
    <footer id="footer">
    <div style="display:inline">
    Copyright &copy; 2023

    CFONG
. Powered by <a href="http://zespia.tw/hexo/" target="_blank">Hexo</a> |
    Theme is <a target="_blank" rel="noopener" href="https://github.com/wd/hexo-fabric">hexo-fabric</a>, fork from <a target="_blank" rel="noopener" href="http://github.com/panks/fabric">fabric</a> by <a target="_blank" rel="noopener" href="http://panks.me">Pankaj Kumar</a>
</div>


    </footer>
    <script src="/javascripts/fabric.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script>
 <!-- Delete or comment this line to disable Fancybox -->



<!-- end toload --> 
</div>
</div>
<script src="/javascripts/jquery.ui.totop.js" type="text/javascript"></script>
<script type="text/javascript">
/*<![CDATA[*/
;(function($){$().UItoTop({easingType:'easeOutCirc'});})(jQuery); 
/*]]>*/
</script><!-- remove it to remove the scroll to top button -->
</body>
</html>
